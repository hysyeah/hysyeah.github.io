<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">






















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="k8s之kube-proxy[上] kube-proxy是Kubernetes集群中的一个核心组件，负责实现服务的负载均衡和网络代理功能。 kube-proxy的源码分析可以涉及多个文件和功能模块，以下是一些主要文件和功能模块的概述： cmd/kube-proxy/app：该包包含了kube-proxy的入口点代码，负责解析命令行参数、初始化配置和启动kube-proxy的主循环 pkg/prox">
<meta name="keywords" content="k8s,kube-proxy">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s之kube-proxy[下]">
<meta property="og:url" content="https://hysyeah.github.io/2023/05/23/k8s之kube-proxy-下/index.html">
<meta property="og:site_name" content="hysyeah">
<meta property="og:description" content="k8s之kube-proxy[上] kube-proxy是Kubernetes集群中的一个核心组件，负责实现服务的负载均衡和网络代理功能。 kube-proxy的源码分析可以涉及多个文件和功能模块，以下是一些主要文件和功能模块的概述： cmd/kube-proxy/app：该包包含了kube-proxy的入口点代码，负责解析命令行参数、初始化配置和启动kube-proxy的主循环 pkg/prox">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2023-09-17T05:23:40.572Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="k8s之kube-proxy[下]">
<meta name="twitter:description" content="k8s之kube-proxy[上] kube-proxy是Kubernetes集群中的一个核心组件，负责实现服务的负载均衡和网络代理功能。 kube-proxy的源码分析可以涉及多个文件和功能模块，以下是一些主要文件和功能模块的概述： cmd/kube-proxy/app：该包包含了kube-proxy的入口点代码，负责解析命令行参数、初始化配置和启动kube-proxy的主循环 pkg/prox">





  
  
  <link rel="canonical" href="https://hysyeah.github.io/2023/05/23/k8s之kube-proxy-下/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>k8s之kube-proxy[下] | hysyeah</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/hysyeah/" class="github-corner" aria-label="View source on GitHub">
    <svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">hysyeah</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">知易行难</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hysyeah.github.io/2023/05/23/k8s之kube-proxy-下/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hys">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hysyeah">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">k8s之kube-proxy[下]

              
            
          </h1>
        

        <div class="post-meta">
          

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2023-05-23 00:14:03" itemprop="dateCreated datePublished" datetime="2023-05-23T00:14:03+08:00">2023-05-23</time>
            </span>
          

          

          

          
            
            
          

          
          

          

          <br>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><a href="https://hysyeah.top/2023/05/20/k8s%E4%B9%8Bkube-proxy/" target="_blank" rel="noopener">k8s之kube-proxy[上]</a></p>
<p><code>kube-proxy</code>是<code>Kubernetes</code>集群中的一个核心组件，负责实现服务的负载均衡和网络代理功能。</p>
<p><code>kube-proxy</code>的源码分析可以涉及多个文件和功能模块，以下是一些主要文件和功能模块的概述：</p>
<p><code>cmd/kube-proxy/app</code>：该包包含了<code>kube-proxy</code>的入口点代码，负责解析命令行参数、初始化配置和启动<code>kube-proxy</code>的主循环</p>
<p><code>pkg/proxy</code>：该目录包含了<code>kube-proxy</code>的核心功能代码</p>
<p><code>pkg/proxy/ipvs</code>：该目录包含了使用IPVS（IP Virtual Server）实现负载均衡的相关代码</p>
<p><code>pkg/proxy/iptables</code>：该目录包含了使用iptables实现负载均衡的相关代码</p>
<p><code>pkg/proxy/util</code>：该目录包含了一些辅助函数和工具类，用于支持<code>kube-proxy</code>的实现</p>
<hr>
<p><code>kube-proxy</code>入口<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-proxy/proxy.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	command := app.NewProxyCommand()</span><br><span class="line">	code := cli.Run(command)</span><br><span class="line">	os.Exit(code)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-proxy/app/server.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Options)</span> <span class="title">Run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(o.errCh)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(o.WriteConfigTo) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> o.writeConfigFile()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> o.CleanupAndExit &#123;</span><br><span class="line">		<span class="keyword">return</span> cleanupAndExit()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	proxyServer, err := NewProxyServer(o)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	o.proxyServer = proxyServer</span><br><span class="line">	<span class="keyword">return</span> o.runLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-proxy/app/server_others.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProxyServer</span><span class="params">(o *Options)</span> <span class="params">(*ProxyServer, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> newProxyServer(o.config, o.master)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newProxyServer</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	config *proxyconfigapi.KubeProxyConfiguration,</span></span></span><br><span class="line"><span class="function"><span class="params">	master <span class="keyword">string</span>)</span> <span class="params">(*ProxyServer, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c, err := configz.New(proxyconfigapi.GroupName); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		c.Set(config)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unable to register configz: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> ipvsInterface utilipvs.Interface</span><br><span class="line">	<span class="keyword">var</span> ipsetInterface utilipset.Interface</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(config.ShowHiddenMetricsForVersion) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		metrics.SetShowHidden()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hostname, err := nodeutil.GetHostname(config.HostnameOverride)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client, err := createClient(config.ClientConnection, master)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nodeIP := detectNodeIP(client, hostname, config.BindAddress)</span><br><span class="line">	klog.InfoS(<span class="string">"Detected node IP"</span>, <span class="string">"address"</span>, nodeIP.String())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create event recorder</span></span><br><span class="line">	eventBroadcaster := events.NewBroadcaster(&amp;events.EventSinkImpl&#123;Interface: client.EventsV1()&#125;)</span><br><span class="line">	recorder := eventBroadcaster.NewRecorder(scheme.Scheme, <span class="string">"kube-proxy"</span>)</span><br><span class="line"></span><br><span class="line">	nodeRef := &amp;v1.ObjectReference&#123;</span><br><span class="line">		Kind:      <span class="string">"Node"</span>,</span><br><span class="line">		Name:      hostname,</span><br><span class="line">		UID:       types.UID(hostname),</span><br><span class="line">		Namespace: <span class="string">""</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> healthzServer healthcheck.ProxierHealthUpdater</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(config.HealthzBindAddress) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		healthzServer = healthcheck.NewProxierHealthServer(config.HealthzBindAddress, <span class="number">2</span>*config.IPTables.SyncPeriod.Duration, recorder, nodeRef)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> proxier proxy.Provider</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> nodeInfo *v1.Node</span><br><span class="line">	<span class="keyword">if</span> config.DetectLocalMode == proxyconfigapi.LocalModeNodeCIDR &#123;</span><br><span class="line">		klog.InfoS(<span class="string">"Watching for node, awaiting podCIDR allocation"</span>, <span class="string">"hostname"</span>, hostname)</span><br><span class="line">		nodeInfo, err = waitForPodCIDR(client, hostname)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		klog.InfoS(<span class="string">"NodeInfo"</span>, <span class="string">"podCIDR"</span>, nodeInfo.Spec.PodCIDR, <span class="string">"podCIDRs"</span>, nodeInfo.Spec.PodCIDRs)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	primaryFamily := v1.IPv4Protocol</span><br><span class="line">	primaryProtocol := utiliptables.ProtocolIPv4</span><br><span class="line">	<span class="keyword">if</span> netutils.IsIPv6(nodeIP) &#123;</span><br><span class="line">		primaryFamily = v1.IPv6Protocol</span><br><span class="line">		primaryProtocol = utiliptables.ProtocolIPv6</span><br><span class="line">	&#125;</span><br><span class="line">	execer := exec.New()</span><br><span class="line">	iptInterface := utiliptables.New(execer, primaryProtocol)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> ipt [<span class="number">2</span>]utiliptables.Interface</span><br><span class="line">	dualStack := <span class="literal">true</span> <span class="comment">// While we assume that node supports, we do further checks below</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create iptables handlers for both families, one is already created</span></span><br><span class="line">	<span class="comment">// Always ordered as IPv4, IPv6</span></span><br><span class="line">	<span class="keyword">if</span> primaryProtocol == utiliptables.ProtocolIPv4 &#123;</span><br><span class="line">		ipt[<span class="number">0</span>] = iptInterface</span><br><span class="line">		ipt[<span class="number">1</span>] = utiliptables.New(execer, utiliptables.ProtocolIPv6)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ipt[<span class="number">0</span>] = utiliptables.New(execer, utiliptables.ProtocolIPv4)</span><br><span class="line">		ipt[<span class="number">1</span>] = iptInterface</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nodePortAddresses := config.NodePortAddresses</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !ipt[<span class="number">0</span>].Present() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"iptables is not supported for primary IP family %q"</span>, primaryProtocol)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> !ipt[<span class="number">1</span>].Present() &#123;</span><br><span class="line">		klog.InfoS(<span class="string">"kube-proxy running in single-stack mode: secondary ipFamily is not supported"</span>, <span class="string">"ipFamily"</span>, ipt[<span class="number">1</span>].Protocol())</span><br><span class="line">		dualStack = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Validate NodePortAddresses is single-stack</span></span><br><span class="line">		npaByFamily := proxyutil.MapCIDRsByIPFamily(config.NodePortAddresses)</span><br><span class="line">		secondaryFamily := proxyutil.OtherIPFamily(primaryFamily)</span><br><span class="line">		badAddrs := npaByFamily[secondaryFamily]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(badAddrs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			klog.InfoS(<span class="string">"Ignoring --nodeport-addresses of the wrong family"</span>, <span class="string">"ipFamily"</span>, secondaryFamily, <span class="string">"addresses"</span>, badAddrs)</span><br><span class="line">			nodePortAddresses = npaByFamily[primaryFamily]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 根据不同的模式设置不同的proxier</span></span><br><span class="line">    <span class="comment">// 现在支持两种模式iptables,ipvs</span></span><br><span class="line">	<span class="keyword">if</span> config.Mode == proxyconfigapi.ProxyModeIPTables &#123;</span><br><span class="line">		klog.InfoS(<span class="string">"Using iptables Proxier"</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> dualStack &#123;</span><br><span class="line">			klog.InfoS(<span class="string">"kube-proxy running in dual-stack mode"</span>, <span class="string">"ipFamily"</span>, iptInterface.Protocol())</span><br><span class="line">			klog.InfoS(<span class="string">"Creating dualStackProxier for iptables"</span>)</span><br><span class="line">			<span class="comment">// Always ordered to match []ipt</span></span><br><span class="line">			<span class="keyword">var</span> localDetectors [<span class="number">2</span>]proxyutiliptables.LocalTrafficDetector</span><br><span class="line">			localDetectors, err = getDualStackLocalDetectorTuple(config.DetectLocalMode, config, ipt, nodeInfo)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unable to create proxier: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// TODO this has side effects that should only happen when Run() is invoked.</span></span><br><span class="line">			proxier, err = iptables.NewDualStackProxier(</span><br><span class="line">				ipt,</span><br><span class="line">				utilsysctl.New(),</span><br><span class="line">				execer,</span><br><span class="line">				config.IPTables.SyncPeriod.Duration,</span><br><span class="line">				config.IPTables.MinSyncPeriod.Duration,</span><br><span class="line">				config.IPTables.MasqueradeAll,</span><br><span class="line">				*config.IPTables.LocalhostNodePorts,</span><br><span class="line">				<span class="keyword">int</span>(*config.IPTables.MasqueradeBit),</span><br><span class="line">				localDetectors,</span><br><span class="line">				hostname,</span><br><span class="line">				nodeIPTuple(config.BindAddress),</span><br><span class="line">				recorder,</span><br><span class="line">				healthzServer,</span><br><span class="line">				nodePortAddresses,</span><br><span class="line">			)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Create a single-stack proxier if and only if the node does not support dual-stack (i.e, no iptables support).</span></span><br><span class="line">			<span class="keyword">var</span> localDetector proxyutiliptables.LocalTrafficDetector</span><br><span class="line">			localDetector, err = getLocalDetector(config.DetectLocalMode, config, iptInterface, nodeInfo)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unable to create proxier: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// TODO this has side effects that should only happen when Run() is invoked.</span></span><br><span class="line">			proxier, err = iptables.NewProxier(</span><br><span class="line">				primaryFamily,</span><br><span class="line">				iptInterface,</span><br><span class="line">				utilsysctl.New(),</span><br><span class="line">				execer,</span><br><span class="line">				config.IPTables.SyncPeriod.Duration,</span><br><span class="line">				config.IPTables.MinSyncPeriod.Duration,</span><br><span class="line">				config.IPTables.MasqueradeAll,</span><br><span class="line">				*config.IPTables.LocalhostNodePorts,</span><br><span class="line">				<span class="keyword">int</span>(*config.IPTables.MasqueradeBit),</span><br><span class="line">				localDetector,</span><br><span class="line">				hostname,</span><br><span class="line">				nodeIP,</span><br><span class="line">				recorder,</span><br><span class="line">				healthzServer,</span><br><span class="line">				nodePortAddresses,</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unable to create proxier: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		proxymetrics.RegisterMetrics()</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> config.Mode == proxyconfigapi.ProxyModeIPVS &#123;</span><br><span class="line">		kernelHandler := ipvs.NewLinuxKernelHandler()</span><br><span class="line">		ipsetInterface = utilipset.New(execer)</span><br><span class="line">		ipvsInterface = utilipvs.New()</span><br><span class="line">		<span class="keyword">if</span> err := ipvs.CanUseIPVSProxier(ipvsInterface, ipsetInterface, config.IPVS.Scheduler); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"can't use the IPVS proxier: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		klog.InfoS(<span class="string">"Using ipvs Proxier"</span>)</span><br><span class="line">		<span class="keyword">if</span> dualStack &#123;</span><br><span class="line">			klog.InfoS(<span class="string">"Creating dualStackProxier for ipvs"</span>)</span><br><span class="line"></span><br><span class="line">			nodeIPs := nodeIPTuple(config.BindAddress)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Always ordered to match []ipt</span></span><br><span class="line">			<span class="keyword">var</span> localDetectors [<span class="number">2</span>]proxyutiliptables.LocalTrafficDetector</span><br><span class="line">			localDetectors, err = getDualStackLocalDetectorTuple(config.DetectLocalMode, config, ipt, nodeInfo)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unable to create proxier: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			proxier, err = ipvs.NewDualStackProxier(</span><br><span class="line">				ipt,</span><br><span class="line">				ipvsInterface,</span><br><span class="line">				ipsetInterface,</span><br><span class="line">				utilsysctl.New(),</span><br><span class="line">				execer,</span><br><span class="line">				config.IPVS.SyncPeriod.Duration,</span><br><span class="line">				config.IPVS.MinSyncPeriod.Duration,</span><br><span class="line">				config.IPVS.ExcludeCIDRs,</span><br><span class="line">				config.IPVS.StrictARP,</span><br><span class="line">				config.IPVS.TCPTimeout.Duration,</span><br><span class="line">				config.IPVS.TCPFinTimeout.Duration,</span><br><span class="line">				config.IPVS.UDPTimeout.Duration,</span><br><span class="line">				config.IPTables.MasqueradeAll,</span><br><span class="line">				<span class="keyword">int</span>(*config.IPTables.MasqueradeBit),</span><br><span class="line">				localDetectors,</span><br><span class="line">				hostname,</span><br><span class="line">				nodeIPs,</span><br><span class="line">				recorder,</span><br><span class="line">				healthzServer,</span><br><span class="line">				config.IPVS.Scheduler,</span><br><span class="line">				nodePortAddresses,</span><br><span class="line">				kernelHandler,</span><br><span class="line">			)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> localDetector proxyutiliptables.LocalTrafficDetector</span><br><span class="line">			localDetector, err = getLocalDetector(config.DetectLocalMode, config, iptInterface, nodeInfo)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unable to create proxier: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			proxier, err = ipvs.NewProxier(</span><br><span class="line">				primaryFamily,</span><br><span class="line">				iptInterface,</span><br><span class="line">				ipvsInterface,</span><br><span class="line">				ipsetInterface,</span><br><span class="line">				utilsysctl.New(),</span><br><span class="line">				execer,</span><br><span class="line">				config.IPVS.SyncPeriod.Duration,</span><br><span class="line">				config.IPVS.MinSyncPeriod.Duration,</span><br><span class="line">				config.IPVS.ExcludeCIDRs,</span><br><span class="line">				config.IPVS.StrictARP,</span><br><span class="line">				config.IPVS.TCPTimeout.Duration,</span><br><span class="line">				config.IPVS.TCPFinTimeout.Duration,</span><br><span class="line">				config.IPVS.UDPTimeout.Duration,</span><br><span class="line">				config.IPTables.MasqueradeAll,</span><br><span class="line">				<span class="keyword">int</span>(*config.IPTables.MasqueradeBit),</span><br><span class="line">				localDetector,</span><br><span class="line">				hostname,</span><br><span class="line">				nodeIP,</span><br><span class="line">				recorder,</span><br><span class="line">				healthzServer,</span><br><span class="line">				config.IPVS.Scheduler,</span><br><span class="line">				nodePortAddresses,</span><br><span class="line">				kernelHandler,</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unable to create proxier: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		proxymetrics.RegisterMetrics()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;ProxyServer&#123;</span><br><span class="line">		Config:        config,</span><br><span class="line">		Client:        client,</span><br><span class="line">		Proxier:       proxier,</span><br><span class="line">		Broadcaster:   eventBroadcaster,</span><br><span class="line">		Recorder:      recorder,</span><br><span class="line">		Conntracker:   &amp;realConntracker&#123;&#125;,</span><br><span class="line">		NodeRef:       nodeRef,</span><br><span class="line">		HealthzServer: healthzServer,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-proxy/app/server.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Options)</span> <span class="title">Run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(o.errCh)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(o.WriteConfigTo) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> o.writeConfigFile()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> o.CleanupAndExit &#123;</span><br><span class="line">		<span class="keyword">return</span> cleanupAndExit()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	proxyServer, err := NewProxyServer(o)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	o.proxyServer = proxyServer</span><br><span class="line">	<span class="keyword">return</span> o.runLoop()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最终调用proxyServer的Run方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Options)</span> <span class="title">runLoop</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> o.watcher != <span class="literal">nil</span> &#123;</span><br><span class="line">		o.watcher.Run()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// run the proxy in goroutine</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		err := o.proxyServer.Run()</span><br><span class="line">		o.errCh &lt;- err</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		err := &lt;-o.errCh</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cmd/kube-proxy/app/server.go</span></span><br><span class="line"><span class="keyword">type</span> ProxyServer <span class="keyword">struct</span> &#123;</span><br><span class="line">	Config *kubeproxyconfig.KubeProxyConfiguration</span><br><span class="line"></span><br><span class="line">	Client        clientset.Interface</span><br><span class="line">	Broadcaster   events.EventBroadcaster</span><br><span class="line">	Recorder      events.EventRecorder</span><br><span class="line">	Conntracker   Conntracker <span class="comment">// if nil, ignored</span></span><br><span class="line">	NodeRef       *v1.ObjectReference</span><br><span class="line">	HealthzServer healthcheck.ProxierHealthUpdater</span><br><span class="line"></span><br><span class="line">	Proxier proxy.Provider</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ProxyServer)</span> <span class="title">Run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// To help debugging, immediately log version</span></span><br><span class="line">	klog.InfoS(<span class="string">"Version info"</span>, <span class="string">"version"</span>, version.Get())</span><br><span class="line"></span><br><span class="line">	klog.InfoS(<span class="string">"Golang settings"</span>, <span class="string">"GOGC"</span>, os.Getenv(<span class="string">"GOGC"</span>), <span class="string">"GOMAXPROCS"</span>, os.Getenv(<span class="string">"GOMAXPROCS"</span>), <span class="string">"GOTRACEBACK"</span>, os.Getenv(<span class="string">"GOTRACEBACK"</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(vmarmol): Use container config for this.</span></span><br><span class="line">	<span class="keyword">var</span> oomAdjuster *oom.OOMAdjuster</span><br><span class="line">	<span class="keyword">if</span> s.Config.OOMScoreAdj != <span class="literal">nil</span> &#123;</span><br><span class="line">		oomAdjuster = oom.NewOOMAdjuster()</span><br><span class="line">		<span class="keyword">if</span> err := oomAdjuster.ApplyOOMScoreAdj(<span class="number">0</span>, <span class="keyword">int</span>(*s.Config.OOMScoreAdj)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.V(<span class="number">2</span>).InfoS(<span class="string">"Failed to apply OOMScore"</span>, <span class="string">"err"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.Broadcaster != <span class="literal">nil</span> &#123;</span><br><span class="line">		stopCh := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">		s.Broadcaster.StartRecordingToSink(stopCh)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO(thockin): make it possible for healthz and metrics to be on the same port.</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> errCh <span class="keyword">chan</span> error</span><br><span class="line">	<span class="keyword">if</span> s.Config.BindAddressHardFail &#123;</span><br><span class="line">		errCh = <span class="built_in">make</span>(<span class="keyword">chan</span> error)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start up a healthz server if requested</span></span><br><span class="line">	serveHealthz(s.HealthzServer, errCh)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start up a metrics server if requested</span></span><br><span class="line">	serveMetrics(s.Config.MetricsBindAddress, s.Config.Mode, s.Config.EnableProfiling, errCh)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tune conntrack, if requested</span></span><br><span class="line">	<span class="comment">// Conntracker is always nil for windows</span></span><br><span class="line">	<span class="keyword">if</span> s.Conntracker != <span class="literal">nil</span> &#123;</span><br><span class="line">		max, err := getConntrackMax(s.Config.Conntrack)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> max &gt; <span class="number">0</span> &#123;</span><br><span class="line">			err := s.Conntracker.SetMax(max)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> err != errReadOnlySysFS &#123;</span><br><span class="line">					<span class="keyword">return</span> err</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// errReadOnlySysFS is caused by a known docker issue (https://github.com/docker/docker/issues/24000),</span></span><br><span class="line">				<span class="comment">// the only remediation we know is to restart the docker daemon.</span></span><br><span class="line">				<span class="comment">// Here we'll send an node event with specific reason and message, the</span></span><br><span class="line">				<span class="comment">// administrator should decide whether and how to handle this issue,</span></span><br><span class="line">				<span class="comment">// whether to drain the node and restart docker.  Occurs in other container runtimes</span></span><br><span class="line">				<span class="comment">// as well.</span></span><br><span class="line">				<span class="comment">// TODO(random-liu): Remove this when the docker bug is fixed.</span></span><br><span class="line">				<span class="keyword">const</span> message = <span class="string">"CRI error: /sys is read-only: "</span> +</span><br><span class="line">					<span class="string">"cannot modify conntrack limits, problems may arise later (If running Docker, see docker issue #24000)"</span></span><br><span class="line">				s.Recorder.Eventf(s.NodeRef, <span class="literal">nil</span>, api.EventTypeWarning, err.Error(), <span class="string">"StartKubeProxy"</span>, message)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> s.Config.Conntrack.TCPEstablishedTimeout != <span class="literal">nil</span> &amp;&amp; s.Config.Conntrack.TCPEstablishedTimeout.Duration &gt; <span class="number">0</span> &#123;</span><br><span class="line">			timeout := <span class="keyword">int</span>(s.Config.Conntrack.TCPEstablishedTimeout.Duration / time.Second)</span><br><span class="line">			<span class="keyword">if</span> err := s.Conntracker.SetTCPEstablishedTimeout(timeout); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> s.Config.Conntrack.TCPCloseWaitTimeout != <span class="literal">nil</span> &amp;&amp; s.Config.Conntrack.TCPCloseWaitTimeout.Duration &gt; <span class="number">0</span> &#123;</span><br><span class="line">			timeout := <span class="keyword">int</span>(s.Config.Conntrack.TCPCloseWaitTimeout.Duration / time.Second)</span><br><span class="line">			<span class="keyword">if</span> err := s.Conntracker.SetTCPCloseWaitTimeout(timeout); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	noProxyName, err := labels.NewRequirement(apis.LabelServiceProxyName, selection.DoesNotExist, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	noHeadlessEndpoints, err := labels.NewRequirement(v1.IsHeadlessService, selection.DoesNotExist, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	labelSelector := labels.NewSelector()</span><br><span class="line">	labelSelector = labelSelector.Add(*noProxyName, *noHeadlessEndpoints)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make informers that filter out objects that want a non-default service proxy.</span></span><br><span class="line">	informerFactory := informers.NewSharedInformerFactoryWithOptions(s.Client, s.Config.ConfigSyncPeriod.Duration,</span><br><span class="line">		informers.WithTweakListOptions(<span class="function"><span class="keyword">func</span><span class="params">(options *metav1.ListOptions)</span></span> &#123;</span><br><span class="line">			options.LabelSelector = labelSelector.String()</span><br><span class="line">		&#125;))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create configs (i.e. Watches for Services and EndpointSlices)</span></span><br><span class="line">	<span class="comment">// Note: RegisterHandler() calls need to happen before creation of Sources because sources</span></span><br><span class="line">	<span class="comment">// only notify on changes, and the initial update (on process start) may be lost if no handlers</span></span><br><span class="line">	<span class="comment">// are registered yet.</span></span><br><span class="line">    <span class="comment">// 这段代码可以理解为通过Informer机制监听Service</span></span><br><span class="line">	serviceConfig := config.NewServiceConfig(informerFactory.Core().V1().Services(), s.Config.ConfigSyncPeriod.Duration)</span><br><span class="line">	serviceConfig.RegisterEventHandler(s.Proxier)</span><br><span class="line">	<span class="keyword">go</span> serviceConfig.Run(wait.NeverStop)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这段代码可以理解为通过Informer机制监听EndpointSlice</span></span><br><span class="line">	endpointSliceConfig := config.NewEndpointSliceConfig(informerFactory.Discovery().V1().EndpointSlices(), s.Config.ConfigSyncPeriod.Duration)</span><br><span class="line">	endpointSliceConfig.RegisterEventHandler(s.Proxier)</span><br><span class="line">	<span class="keyword">go</span> endpointSliceConfig.Run(wait.NeverStop)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This has to start after the calls to NewServiceConfig because that</span></span><br><span class="line">	<span class="comment">// function must configure its shared informer event handlers first.</span></span><br><span class="line">	informerFactory.Start(wait.NeverStop)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make an informer that selects for our nodename.</span></span><br><span class="line">	currentNodeInformerFactory := informers.NewSharedInformerFactoryWithOptions(s.Client, s.Config.ConfigSyncPeriod.Duration,</span><br><span class="line">		informers.WithTweakListOptions(<span class="function"><span class="keyword">func</span><span class="params">(options *metav1.ListOptions)</span></span> &#123;</span><br><span class="line">			options.FieldSelector = fields.OneTermEqualSelector(<span class="string">"metadata.name"</span>, s.NodeRef.Name).String()</span><br><span class="line">		&#125;))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这段代码可以理解为通过Informer机制监听Node</span></span><br><span class="line">	nodeConfig := config.NewNodeConfig(currentNodeInformerFactory.Core().V1().Nodes(), s.Config.ConfigSyncPeriod.Duration)</span><br><span class="line">	<span class="comment">// https://issues.k8s.io/111321</span></span><br><span class="line">	<span class="keyword">if</span> s.Config.DetectLocalMode == kubeproxyconfig.LocalModeNodeCIDR &#123;</span><br><span class="line">		nodeConfig.RegisterEventHandler(&amp;proxy.NodePodCIDRHandler&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	nodeConfig.RegisterEventHandler(s.Proxier)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> nodeConfig.Run(wait.NeverStop)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This has to start after the calls to NewNodeConfig because that must</span></span><br><span class="line">	<span class="comment">// configure the shared informer event handler first.</span></span><br><span class="line">	currentNodeInformerFactory.Start(wait.NeverStop)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Birth Cry after the birth is successful</span></span><br><span class="line">	s.birthCry()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// iptables/ipvs Proxier都实现了SyncLoop()</span></span><br><span class="line">	<span class="keyword">go</span> s.Proxier.SyncLoop()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &lt;-errCh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServiceConfig, endpointSliceConfig, nodeConfig</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/proxy/config/config.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServiceConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	listerSynced  cache.InformerSynced</span><br><span class="line">	eventHandlers []ServiceHandler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewServiceConfig creates a new ServiceConfig.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServiceConfig</span><span class="params">(serviceInformer coreinformers.ServiceInformer, resyncPeriod time.Duration)</span> *<span class="title">ServiceConfig</span></span> &#123;</span><br><span class="line">	result := &amp;ServiceConfig&#123;</span><br><span class="line">		listerSynced: serviceInformer.Informer().HasSynced,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	serviceInformer.Informer().AddEventHandlerWithResyncPeriod(</span><br><span class="line">		cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">			AddFunc:    result.handleAddService,</span><br><span class="line">			UpdateFunc: result.handleUpdateService,</span><br><span class="line">			DeleteFunc: result.handleDeleteService,</span><br><span class="line">		&#125;,</span><br><span class="line">		resyncPeriod,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run waits for cache synced and invokes handlers after syncing.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ServiceConfig)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	klog.InfoS(<span class="string">"Starting service config controller"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !cache.WaitForNamedCacheSync(<span class="string">"service config"</span>, stopCh, c.listerSynced) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> c.eventHandlers &#123;</span><br><span class="line">		klog.V(<span class="number">3</span>).InfoS(<span class="string">"Calling handler.OnServiceSynced()"</span>)</span><br><span class="line">        <span class="comment">// 当所有初始事件处理程序都被调用并且状态完全更新到本地缓存后调用</span></span><br><span class="line">		c.eventHandlers[i].OnServiceSynced()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NodeConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	listerSynced  cache.InformerSynced</span><br><span class="line">	eventHandlers []NodeHandler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewNodeConfig creates a new NodeConfig.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNodeConfig</span><span class="params">(nodeInformer coreinformers.NodeInformer, resyncPeriod time.Duration)</span> *<span class="title">NodeConfig</span></span> &#123;</span><br><span class="line">	result := &amp;NodeConfig&#123;</span><br><span class="line">		listerSynced: nodeInformer.Informer().HasSynced,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	nodeInformer.Informer().AddEventHandlerWithResyncPeriod(</span><br><span class="line">		cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">			AddFunc:    result.handleAddNode,</span><br><span class="line">			UpdateFunc: result.handleUpdateNode,</span><br><span class="line">			DeleteFunc: result.handleDeleteNode,</span><br><span class="line">		&#125;,</span><br><span class="line">		resyncPeriod,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run starts the goroutine responsible for calling registered handlers.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *NodeConfig)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	klog.InfoS(<span class="string">"Starting node config controller"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !cache.WaitForNamedCacheSync(<span class="string">"node config"</span>, stopCh, c.listerSynced) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> c.eventHandlers &#123;</span><br><span class="line">		klog.V(<span class="number">3</span>).InfoS(<span class="string">"Calling handler.OnNodeSynced()"</span>)</span><br><span class="line">		c.eventHandlers[i].OnNodeSynced()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> EndpointSliceConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	listerSynced  cache.InformerSynced</span><br><span class="line">	eventHandlers []EndpointSliceHandler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewEndpointSliceConfig creates a new EndpointSliceConfig.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEndpointSliceConfig</span><span class="params">(endpointSliceInformer discoveryinformers.EndpointSliceInformer, resyncPeriod time.Duration)</span> *<span class="title">EndpointSliceConfig</span></span> &#123;</span><br><span class="line">	result := &amp;EndpointSliceConfig&#123;</span><br><span class="line">		listerSynced: endpointSliceInformer.Informer().HasSynced,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	endpointSliceInformer.Informer().AddEventHandlerWithResyncPeriod(</span><br><span class="line">		cache.ResourceEventHandlerFuncs&#123;</span><br><span class="line">			AddFunc:    result.handleAddEndpointSlice,</span><br><span class="line">			UpdateFunc: result.handleUpdateEndpointSlice,</span><br><span class="line">			DeleteFunc: result.handleDeleteEndpointSlice,</span><br><span class="line">		&#125;,</span><br><span class="line">		resyncPeriod,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run waits for cache synced and invokes handlers after syncing.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *EndpointSliceConfig)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	klog.InfoS(<span class="string">"Starting endpoint slice config controller"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !cache.WaitForNamedCacheSync(<span class="string">"endpoint slice config"</span>, stopCh, c.listerSynced) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, h := <span class="keyword">range</span> c.eventHandlers &#123;</span><br><span class="line">		klog.V(<span class="number">3</span>).InfoS(<span class="string">"Calling handler.OnEndpointSlicesSynced()"</span>)</span><br><span class="line">		h.OnEndpointSlicesSynced()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/proxy/ipvs/proxier.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(proxier *Proxier)</span> <span class="title">SyncLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Update healthz timestamp at beginning in case Sync() never succeeds.</span></span><br><span class="line">	<span class="keyword">if</span> proxier.healthzServer != <span class="literal">nil</span> &#123;</span><br><span class="line">		proxier.healthzServer.Updated()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// synthesize "last change queued" time as the informers are syncing.</span></span><br><span class="line">	metrics.SyncProxyRulesLastQueuedTimestamp.SetToCurrentTime()</span><br><span class="line">    <span class="comment">// 周期性的执行对应的参数</span></span><br><span class="line">	proxier.syncRunner.Loop(wait.NeverStop)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProxier</span><span class="params">(ipFamily v1.IPFamily...)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// syncRunner初始化，fn为proxier.syncProxyRules</span></span><br><span class="line">    <span class="comment">// iptables,ipvs都实现了syncProxyRules</span></span><br><span class="line">    <span class="comment">// 周期性执行的方法`syncProxyRules`就是`kube-proxy`的核心逻辑，根据`Service`,`EndpointSlice`,`Node`的变化分别更新iptables或ipvs</span></span><br><span class="line">    proxier.syncRunner = async.NewBoundedFrequencyRunner(<span class="string">"sync-runner"</span>, proxier.syncProxyRules, minSyncPeriod, syncPeriod, burstSyncs)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pkg/proxy/iptables/proxier.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(proxier *Proxier)</span> <span class="title">SyncLoop</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Update healthz timestamp at beginning in case Sync() never succeeds.</span></span><br><span class="line">	<span class="keyword">if</span> proxier.healthzServer != <span class="literal">nil</span> &#123;</span><br><span class="line">		proxier.healthzServer.Updated()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// synthesize "last change queued" time as the informers are syncing.</span></span><br><span class="line">	metrics.SyncProxyRulesLastQueuedTimestamp.SetToCurrentTime()</span><br><span class="line">	proxier.syncRunner.Loop(wait.NeverStop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProxier</span><span class="params">(ipFamily v1.IPFamily...)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// syncRunner初始化，fn为proxier.syncProxyRules</span></span><br><span class="line">    proxier.syncRunner = async.NewBoundedFrequencyRunner(<span class="string">"sync-runner"</span>, proxier.syncProxyRules, minSyncPeriod, time.Hour, burstSyncs)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>iptables syncProxyRules<br>这函数代码太长后面再慢慢分析<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pkg/proxy/iptables/proxier.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(proxier *Proxier)</span> <span class="title">syncProxyRules</span><span class="params">()</span></span> &#123;</span><br><span class="line">	proxier.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> proxier.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// don't sync rules till we've received services and endpoints</span></span><br><span class="line">	<span class="keyword">if</span> !proxier.isInitialized() &#123;</span><br><span class="line">		klog.V(<span class="number">2</span>).InfoS(<span class="string">"Not syncing iptables until Services and Endpoints have been received from master"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The value of proxier.needFullSync may change before the defer funcs run, so</span></span><br><span class="line">	<span class="comment">// we need to keep track of whether it was set at the *start* of the sync.</span></span><br><span class="line">	tryPartialSync := !proxier.needFullSync</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Keep track of how long syncs take.</span></span><br><span class="line">	start := time.Now()</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		metrics.SyncProxyRulesLatency.Observe(metrics.SinceInSeconds(start))</span><br><span class="line">		<span class="keyword">if</span> tryPartialSync &#123;</span><br><span class="line">			metrics.SyncPartialProxyRulesLatency.Observe(metrics.SinceInSeconds(start))</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			metrics.SyncFullProxyRulesLatency.Observe(metrics.SinceInSeconds(start))</span><br><span class="line">		&#125;</span><br><span class="line">		klog.V(<span class="number">2</span>).InfoS(<span class="string">"SyncProxyRules complete"</span>, <span class="string">"elapsed"</span>, time.Since(start))</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> serviceChanged, endpointsChanged sets.Set[<span class="keyword">string</span>]</span><br><span class="line">	<span class="keyword">if</span> tryPartialSync &#123;</span><br><span class="line">		serviceChanged = proxier.serviceChanges.PendingChanges()</span><br><span class="line">		endpointsChanged = proxier.endpointsChanges.PendingChanges()</span><br><span class="line">	&#125;</span><br><span class="line">	serviceUpdateResult := proxier.svcPortMap.Update(proxier.serviceChanges)</span><br><span class="line">	endpointUpdateResult := proxier.endpointsMap.Update(proxier.endpointsChanges)</span><br><span class="line"></span><br><span class="line">	klog.V(<span class="number">2</span>).InfoS(<span class="string">"Syncing iptables rules"</span>)</span><br><span class="line"></span><br><span class="line">	success := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !success &#123;</span><br><span class="line">			klog.InfoS(<span class="string">"Sync failed"</span>, <span class="string">"retryingTime"</span>, proxier.syncPeriod)</span><br><span class="line">			proxier.syncRunner.RetryAfter(proxier.syncPeriod)</span><br><span class="line">			<span class="keyword">if</span> tryPartialSync &#123;</span><br><span class="line">				metrics.IptablesPartialRestoreFailuresTotal.Inc()</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// proxier.serviceChanges and proxier.endpointChanges have already</span></span><br><span class="line">			<span class="comment">// been flushed, so we've lost the state needed to be able to do</span></span><br><span class="line">			<span class="comment">// a partial sync.</span></span><br><span class="line">			proxier.needFullSync = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !tryPartialSync &#123;</span><br><span class="line">		<span class="comment">// Ensure that our jump rules (eg from PREROUTING to KUBE-SERVICES) exist.</span></span><br><span class="line">		<span class="comment">// We can't do this as part of the iptables-restore because we don't want</span></span><br><span class="line">		<span class="comment">// to specify/replace *all* of the rules in PREROUTING, etc.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// We need to create these rules when kube-proxy first starts, and we need</span></span><br><span class="line">		<span class="comment">// to recreate them if the utiliptables Monitor detects that iptables has</span></span><br><span class="line">		<span class="comment">// been flushed. In both of those cases, the code will force a full sync.</span></span><br><span class="line">		<span class="comment">// In all other cases, it ought to be safe to assume that the rules</span></span><br><span class="line">		<span class="comment">// already exist, so we'll skip this step when doing a partial sync, to</span></span><br><span class="line">		<span class="comment">// save us from having to invoke /sbin/iptables 20 times on each sync</span></span><br><span class="line">		<span class="comment">// (which will be very slow on hosts with lots of iptables rules).</span></span><br><span class="line">		<span class="keyword">for</span> _, jump := <span class="keyword">range</span> <span class="built_in">append</span>(iptablesJumpChains, iptablesKubeletJumpChains...) &#123;</span><br><span class="line">			<span class="keyword">if</span> _, err := proxier.iptables.EnsureChain(jump.table, jump.dstChain); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.ErrorS(err, <span class="string">"Failed to ensure chain exists"</span>, <span class="string">"table"</span>, jump.table, <span class="string">"chain"</span>, jump.dstChain)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			args := jump.extraArgs</span><br><span class="line">			<span class="keyword">if</span> jump.comment != <span class="string">""</span> &#123;</span><br><span class="line">				args = <span class="built_in">append</span>(args, <span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, jump.comment)</span><br><span class="line">			&#125;</span><br><span class="line">			args = <span class="built_in">append</span>(args, <span class="string">"-j"</span>, <span class="keyword">string</span>(jump.dstChain))</span><br><span class="line">			<span class="keyword">if</span> _, err := proxier.iptables.EnsureRule(utiliptables.Prepend, jump.table, jump.srcChain, args...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.ErrorS(err, <span class="string">"Failed to ensure chain jumps"</span>, <span class="string">"table"</span>, jump.table, <span class="string">"srcChain"</span>, jump.srcChain, <span class="string">"dstChain"</span>, jump.dstChain)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Below this point we will not return until we try to write the iptables rules.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Reset all buffers used later.</span></span><br><span class="line">	<span class="comment">// This is to avoid memory reallocations and thus improve performance.</span></span><br><span class="line">	proxier.filterChains.Reset()</span><br><span class="line">	proxier.filterRules.Reset()</span><br><span class="line">	proxier.natChains.Reset()</span><br><span class="line">	proxier.natRules.Reset()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Write chain lines for all the "top-level" chains we'll be filling in</span></span><br><span class="line">	<span class="keyword">for</span> _, chainName := <span class="keyword">range</span> []utiliptables.Chain&#123;kubeServicesChain, kubeExternalServicesChain, kubeForwardChain, kubeNodePortsChain, kubeProxyFirewallChain&#125; &#123;</span><br><span class="line">		proxier.filterChains.Write(utiliptables.MakeChainLine(chainName))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, chainName := <span class="keyword">range</span> []utiliptables.Chain&#123;kubeServicesChain, kubeNodePortsChain, kubePostroutingChain, kubeMarkMasqChain&#125; &#123;</span><br><span class="line">		proxier.natChains.Write(utiliptables.MakeChainLine(chainName))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Install the kubernetes-specific postrouting rules. We use a whole chain for</span></span><br><span class="line">	<span class="comment">// this so that it is easier to flush and change, for example if the mark</span></span><br><span class="line">	<span class="comment">// value should ever change.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> kubelet creates identical copies of these rules. If you want to change</span></span><br><span class="line">	<span class="comment">// these rules in the future, you MUST do so in a way that will interoperate</span></span><br><span class="line">	<span class="comment">// correctly with skewed versions of the rules created by kubelet. (Remove this</span></span><br><span class="line">	<span class="comment">// comment once IPTablesOwnershipCleanup is GA.)</span></span><br><span class="line"></span><br><span class="line">	proxier.natRules.Write(</span><br><span class="line">		<span class="string">"-A"</span>, <span class="keyword">string</span>(kubePostroutingChain),</span><br><span class="line">		<span class="string">"-m"</span>, <span class="string">"mark"</span>, <span class="string">"!"</span>, <span class="string">"--mark"</span>, fmt.Sprintf(<span class="string">"%s/%s"</span>, proxier.masqueradeMark, proxier.masqueradeMark),</span><br><span class="line">		<span class="string">"-j"</span>, <span class="string">"RETURN"</span>,</span><br><span class="line">	)</span><br><span class="line">	<span class="comment">// Clear the mark to avoid re-masquerading if the packet re-traverses the network stack.</span></span><br><span class="line">	proxier.natRules.Write(</span><br><span class="line">		<span class="string">"-A"</span>, <span class="keyword">string</span>(kubePostroutingChain),</span><br><span class="line">		<span class="string">"-j"</span>, <span class="string">"MARK"</span>, <span class="string">"--xor-mark"</span>, proxier.masqueradeMark,</span><br><span class="line">	)</span><br><span class="line">	masqRule := []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"-A"</span>, <span class="keyword">string</span>(kubePostroutingChain),</span><br><span class="line">		<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, <span class="string">`"kubernetes service traffic requiring SNAT"`</span>,</span><br><span class="line">		<span class="string">"-j"</span>, <span class="string">"MASQUERADE"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> proxier.iptables.HasRandomFully() &#123;</span><br><span class="line">		masqRule = <span class="built_in">append</span>(masqRule, <span class="string">"--random-fully"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	proxier.natRules.Write(masqRule)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Install the kubernetes-specific masquerade mark rule. We use a whole chain for</span></span><br><span class="line">	<span class="comment">// this so that it is easier to flush and change, for example if the mark</span></span><br><span class="line">	<span class="comment">// value should ever change.</span></span><br><span class="line">	proxier.natRules.Write(</span><br><span class="line">		<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeMarkMasqChain),</span><br><span class="line">		<span class="string">"-j"</span>, <span class="string">"MARK"</span>, <span class="string">"--or-mark"</span>, proxier.masqueradeMark,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	isIPv6 := proxier.iptables.IsIPv6()</span><br><span class="line">	<span class="keyword">if</span> !isIPv6 &amp;&amp; proxier.localhostNodePorts &#123;</span><br><span class="line">		<span class="comment">// Kube-proxy's use of `route_localnet` to enable NodePorts on localhost</span></span><br><span class="line">		<span class="comment">// creates a security hole (https://issue.k8s.io/90259) which this</span></span><br><span class="line">		<span class="comment">// iptables rule mitigates.</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// <span class="doctag">NOTE:</span> kubelet creates an identical copy of this rule. If you want to</span></span><br><span class="line">		<span class="comment">// change this rule in the future, you MUST do so in a way that will</span></span><br><span class="line">		<span class="comment">// interoperate correctly with skewed versions of the rule created by</span></span><br><span class="line">		<span class="comment">// kubelet. (Actually, kubelet uses "--dst"/"--src" rather than "-d"/"-s"</span></span><br><span class="line">		<span class="comment">// but that's just a command-line thing and results in the same rule being</span></span><br><span class="line">		<span class="comment">// created in the kernel.)</span></span><br><span class="line">		proxier.filterChains.Write(utiliptables.MakeChainLine(kubeletFirewallChain))</span><br><span class="line">		proxier.filterRules.Write(</span><br><span class="line">			<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeletFirewallChain),</span><br><span class="line">			<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, <span class="string">`"block incoming localnet connections"`</span>,</span><br><span class="line">			<span class="string">"-d"</span>, <span class="string">"127.0.0.0/8"</span>,</span><br><span class="line">			<span class="string">"!"</span>, <span class="string">"-s"</span>, <span class="string">"127.0.0.0/8"</span>,</span><br><span class="line">			<span class="string">"-m"</span>, <span class="string">"conntrack"</span>,</span><br><span class="line">			<span class="string">"!"</span>, <span class="string">"--ctstate"</span>, <span class="string">"RELATED,ESTABLISHED,DNAT"</span>,</span><br><span class="line">			<span class="string">"-j"</span>, <span class="string">"DROP"</span>,</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Accumulate NAT chains to keep.</span></span><br><span class="line">	activeNATChains := <span class="keyword">map</span>[utiliptables.Chain]<span class="keyword">bool</span>&#123;&#125; <span class="comment">// use a map as a set</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// To avoid growing this slice, we arbitrarily set its size to 64,</span></span><br><span class="line">	<span class="comment">// there is never more than that many arguments for a single line.</span></span><br><span class="line">	<span class="comment">// Note that even if we go over 64, it will still be correct - it</span></span><br><span class="line">	<span class="comment">// is just for efficiency, not correctness.</span></span><br><span class="line">	args := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compute total number of endpoint chains across all services</span></span><br><span class="line">	<span class="comment">// to get a sense of how big the cluster is.</span></span><br><span class="line">	totalEndpoints := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> svcName := <span class="keyword">range</span> proxier.svcPortMap &#123;</span><br><span class="line">		totalEndpoints += <span class="built_in">len</span>(proxier.endpointsMap[svcName])</span><br><span class="line">	&#125;</span><br><span class="line">	proxier.largeClusterMode = (totalEndpoints &gt; largeClusterEndpointsThreshold)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// These two variables are used to publish the sync_proxy_rules_no_endpoints_total</span></span><br><span class="line">	<span class="comment">// metric.</span></span><br><span class="line">	serviceNoLocalEndpointsTotalInternal := <span class="number">0</span></span><br><span class="line">	serviceNoLocalEndpointsTotalExternal := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Build rules for each service-port.</span></span><br><span class="line">	<span class="keyword">for</span> svcName, svc := <span class="keyword">range</span> proxier.svcPortMap &#123;</span><br><span class="line">		svcInfo, ok := svc.(*servicePortInfo)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">"Failed to cast serviceInfo"</span>, <span class="string">"serviceName"</span>, svcName)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		protocol := strings.ToLower(<span class="keyword">string</span>(svcInfo.Protocol()))</span><br><span class="line">		svcPortNameString := svcInfo.nameString</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Figure out the endpoints for Cluster and Local traffic policy.</span></span><br><span class="line">		<span class="comment">// allLocallyReachableEndpoints is the set of all endpoints that can be routed to</span></span><br><span class="line">		<span class="comment">// from this node, given the service's traffic policies. hasEndpoints is true</span></span><br><span class="line">		<span class="comment">// if the service has any usable endpoints on any node, not just this one.</span></span><br><span class="line">		allEndpoints := proxier.endpointsMap[svcName]</span><br><span class="line">		clusterEndpoints, localEndpoints, allLocallyReachableEndpoints, hasEndpoints := proxy.CategorizeEndpoints(allEndpoints, svcInfo, proxier.nodeLabels)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Note the endpoint chains that will be used</span></span><br><span class="line">		<span class="keyword">for</span> _, ep := <span class="keyword">range</span> allLocallyReachableEndpoints &#123;</span><br><span class="line">			<span class="keyword">if</span> epInfo, ok := ep.(*endpointsInfo); ok &#123;</span><br><span class="line">				activeNATChains[epInfo.ChainName] = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// clusterPolicyChain contains the endpoints used with "Cluster" traffic policy</span></span><br><span class="line">		clusterPolicyChain := svcInfo.clusterPolicyChainName</span><br><span class="line">		usesClusterPolicyChain := <span class="built_in">len</span>(clusterEndpoints) &gt; <span class="number">0</span> &amp;&amp; svcInfo.UsesClusterEndpoints()</span><br><span class="line">		<span class="keyword">if</span> usesClusterPolicyChain &#123;</span><br><span class="line">			activeNATChains[clusterPolicyChain] = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// localPolicyChain contains the endpoints used with "Local" traffic policy</span></span><br><span class="line">		localPolicyChain := svcInfo.localPolicyChainName</span><br><span class="line">		usesLocalPolicyChain := <span class="built_in">len</span>(localEndpoints) &gt; <span class="number">0</span> &amp;&amp; svcInfo.UsesLocalEndpoints()</span><br><span class="line">		<span class="keyword">if</span> usesLocalPolicyChain &#123;</span><br><span class="line">			activeNATChains[localPolicyChain] = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// internalPolicyChain is the chain containing the endpoints for</span></span><br><span class="line">		<span class="comment">// "internal" (ClusterIP) traffic. internalTrafficChain is the chain that</span></span><br><span class="line">		<span class="comment">// internal traffic is routed to (which is always the same as</span></span><br><span class="line">		<span class="comment">// internalPolicyChain). hasInternalEndpoints is true if we should</span></span><br><span class="line">		<span class="comment">// generate rules pointing to internalTrafficChain, or false if there are</span></span><br><span class="line">		<span class="comment">// no available internal endpoints.</span></span><br><span class="line">		internalPolicyChain := clusterPolicyChain</span><br><span class="line">		hasInternalEndpoints := hasEndpoints</span><br><span class="line">		<span class="keyword">if</span> svcInfo.InternalPolicyLocal() &#123;</span><br><span class="line">			internalPolicyChain = localPolicyChain</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(localEndpoints) == <span class="number">0</span> &#123;</span><br><span class="line">				hasInternalEndpoints = <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		internalTrafficChain := internalPolicyChain</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Similarly, externalPolicyChain is the chain containing the endpoints</span></span><br><span class="line">		<span class="comment">// for "external" (NodePort, LoadBalancer, and ExternalIP) traffic.</span></span><br><span class="line">		<span class="comment">// externalTrafficChain is the chain that external traffic is routed to</span></span><br><span class="line">		<span class="comment">// (which is always the service's "EXT" chain). hasExternalEndpoints is</span></span><br><span class="line">		<span class="comment">// true if there are endpoints that will be reached by external traffic.</span></span><br><span class="line">		<span class="comment">// (But we may still have to generate externalTrafficChain even if there</span></span><br><span class="line">		<span class="comment">// are no external endpoints, to ensure that the short-circuit rules for</span></span><br><span class="line">		<span class="comment">// local traffic are set up.)</span></span><br><span class="line">		externalPolicyChain := clusterPolicyChain</span><br><span class="line">		hasExternalEndpoints := hasEndpoints</span><br><span class="line">		<span class="keyword">if</span> svcInfo.ExternalPolicyLocal() &#123;</span><br><span class="line">			externalPolicyChain = localPolicyChain</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(localEndpoints) == <span class="number">0</span> &#123;</span><br><span class="line">				hasExternalEndpoints = <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		externalTrafficChain := svcInfo.externalChainName <span class="comment">// eventually jumps to externalPolicyChain</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// usesExternalTrafficChain is based on hasEndpoints, not hasExternalEndpoints,</span></span><br><span class="line">		<span class="comment">// because we need the local-traffic-short-circuiting rules even when there</span></span><br><span class="line">		<span class="comment">// are no externally-usable endpoints.</span></span><br><span class="line">		usesExternalTrafficChain := hasEndpoints &amp;&amp; svcInfo.ExternallyAccessible()</span><br><span class="line">		<span class="keyword">if</span> usesExternalTrafficChain &#123;</span><br><span class="line">			activeNATChains[externalTrafficChain] = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Traffic to LoadBalancer IPs can go directly to externalTrafficChain</span></span><br><span class="line">		<span class="comment">// unless LoadBalancerSourceRanges is in use in which case we will</span></span><br><span class="line">		<span class="comment">// create a firewall chain.</span></span><br><span class="line">		loadBalancerTrafficChain := externalTrafficChain</span><br><span class="line">		fwChain := svcInfo.firewallChainName</span><br><span class="line">		usesFWChain := hasEndpoints &amp;&amp; <span class="built_in">len</span>(svcInfo.LoadBalancerIPStrings()) &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(svcInfo.LoadBalancerSourceRanges()) &gt; <span class="number">0</span></span><br><span class="line">		<span class="keyword">if</span> usesFWChain &#123;</span><br><span class="line">			activeNATChains[fwChain] = <span class="literal">true</span></span><br><span class="line">			loadBalancerTrafficChain = fwChain</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> internalTrafficFilterTarget, internalTrafficFilterComment <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">var</span> externalTrafficFilterTarget, externalTrafficFilterComment <span class="keyword">string</span></span><br><span class="line">		<span class="keyword">if</span> !hasEndpoints &#123;</span><br><span class="line">			<span class="comment">// The service has no endpoints at all; hasInternalEndpoints and</span></span><br><span class="line">			<span class="comment">// hasExternalEndpoints will also be false, and we will not</span></span><br><span class="line">			<span class="comment">// generate any chains in the "nat" table for the service; only</span></span><br><span class="line">			<span class="comment">// rules in the "filter" table rejecting incoming packets for</span></span><br><span class="line">			<span class="comment">// the service's IPs.</span></span><br><span class="line">			internalTrafficFilterTarget = <span class="string">"REJECT"</span></span><br><span class="line">			internalTrafficFilterComment = fmt.Sprintf(<span class="string">`"%s has no endpoints"`</span>, svcPortNameString)</span><br><span class="line">			externalTrafficFilterTarget = <span class="string">"REJECT"</span></span><br><span class="line">			externalTrafficFilterComment = internalTrafficFilterComment</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> !hasInternalEndpoints &#123;</span><br><span class="line">				<span class="comment">// The internalTrafficPolicy is "Local" but there are no local</span></span><br><span class="line">				<span class="comment">// endpoints. Traffic to the clusterIP will be dropped, but</span></span><br><span class="line">				<span class="comment">// external traffic may still be accepted.</span></span><br><span class="line">				internalTrafficFilterTarget = <span class="string">"DROP"</span></span><br><span class="line">				internalTrafficFilterComment = fmt.Sprintf(<span class="string">`"%s has no local endpoints"`</span>, svcPortNameString)</span><br><span class="line">				serviceNoLocalEndpointsTotalInternal++</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> !hasExternalEndpoints &#123;</span><br><span class="line">				<span class="comment">// The externalTrafficPolicy is "Local" but there are no</span></span><br><span class="line">				<span class="comment">// local endpoints. Traffic to "external" IPs from outside</span></span><br><span class="line">				<span class="comment">// the cluster will be dropped, but traffic from inside</span></span><br><span class="line">				<span class="comment">// the cluster may still be accepted.</span></span><br><span class="line">				externalTrafficFilterTarget = <span class="string">"DROP"</span></span><br><span class="line">				externalTrafficFilterComment = fmt.Sprintf(<span class="string">`"%s has no local endpoints"`</span>, svcPortNameString)</span><br><span class="line">				serviceNoLocalEndpointsTotalExternal++</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture the clusterIP.</span></span><br><span class="line">		<span class="keyword">if</span> hasInternalEndpoints &#123;</span><br><span class="line">			proxier.natRules.Write(</span><br><span class="line">				<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeServicesChain),</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"%s cluster IP"`</span>, svcPortNameString),</span><br><span class="line">				<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">				<span class="string">"-d"</span>, svcInfo.ClusterIP().String(),</span><br><span class="line">				<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">				<span class="string">"-j"</span>, <span class="keyword">string</span>(internalTrafficChain))</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// No endpoints.</span></span><br><span class="line">			proxier.filterRules.Write(</span><br><span class="line">				<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeServicesChain),</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, internalTrafficFilterComment,</span><br><span class="line">				<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">				<span class="string">"-d"</span>, svcInfo.ClusterIP().String(),</span><br><span class="line">				<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">				<span class="string">"-j"</span>, internalTrafficFilterTarget,</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture externalIPs.</span></span><br><span class="line">		<span class="keyword">for</span> _, externalIP := <span class="keyword">range</span> svcInfo.ExternalIPStrings() &#123;</span><br><span class="line">			<span class="keyword">if</span> hasEndpoints &#123;</span><br><span class="line">				<span class="comment">// Send traffic bound for external IPs to the "external</span></span><br><span class="line">				<span class="comment">// destinations" chain.</span></span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeServicesChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"%s external IP"`</span>, svcPortNameString),</span><br><span class="line">					<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">					<span class="string">"-d"</span>, externalIP,</span><br><span class="line">					<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(externalTrafficChain))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> !hasExternalEndpoints &#123;</span><br><span class="line">				<span class="comment">// Either no endpoints at all (REJECT) or no endpoints for</span></span><br><span class="line">				<span class="comment">// external traffic (DROP anything that didn't get</span></span><br><span class="line">				<span class="comment">// short-circuited by the EXT chain.)</span></span><br><span class="line">				proxier.filterRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeExternalServicesChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, externalTrafficFilterComment,</span><br><span class="line">					<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">					<span class="string">"-d"</span>, externalIP,</span><br><span class="line">					<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">					<span class="string">"-j"</span>, externalTrafficFilterTarget,</span><br><span class="line">				)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture load-balancer ingress.</span></span><br><span class="line">		<span class="keyword">for</span> _, lbip := <span class="keyword">range</span> svcInfo.LoadBalancerIPStrings() &#123;</span><br><span class="line">			<span class="keyword">if</span> hasEndpoints &#123;</span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeServicesChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"%s loadbalancer IP"`</span>, svcPortNameString),</span><br><span class="line">					<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">					<span class="string">"-d"</span>, lbip,</span><br><span class="line">					<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(loadBalancerTrafficChain))</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> usesFWChain &#123;</span><br><span class="line">				proxier.filterRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeProxyFirewallChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"%s traffic not accepted by %s"`</span>, svcPortNameString, svcInfo.firewallChainName),</span><br><span class="line">					<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">					<span class="string">"-d"</span>, lbip,</span><br><span class="line">					<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">					<span class="string">"-j"</span>, <span class="string">"DROP"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !hasExternalEndpoints &#123;</span><br><span class="line">			<span class="comment">// Either no endpoints at all (REJECT) or no endpoints for</span></span><br><span class="line">			<span class="comment">// external traffic (DROP anything that didn't get short-circuited</span></span><br><span class="line">			<span class="comment">// by the EXT chain.)</span></span><br><span class="line">			<span class="keyword">for</span> _, lbip := <span class="keyword">range</span> svcInfo.LoadBalancerIPStrings() &#123;</span><br><span class="line">				proxier.filterRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeExternalServicesChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, externalTrafficFilterComment,</span><br><span class="line">					<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">					<span class="string">"-d"</span>, lbip,</span><br><span class="line">					<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">					<span class="string">"-j"</span>, externalTrafficFilterTarget,</span><br><span class="line">				)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture nodeports.</span></span><br><span class="line">		<span class="keyword">if</span> svcInfo.NodePort() != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> hasEndpoints &#123;</span><br><span class="line">				<span class="comment">// Jump to the external destination chain.  For better or for</span></span><br><span class="line">				<span class="comment">// worse, nodeports are not subect to loadBalancerSourceRanges,</span></span><br><span class="line">				<span class="comment">// and we can't change that.</span></span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeNodePortsChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, svcPortNameString,</span><br><span class="line">					<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">					<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.NodePort()),</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(externalTrafficChain))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> !hasExternalEndpoints &#123;</span><br><span class="line">				<span class="comment">// Either no endpoints at all (REJECT) or no endpoints for</span></span><br><span class="line">				<span class="comment">// external traffic (DROP anything that didn't get</span></span><br><span class="line">				<span class="comment">// short-circuited by the EXT chain.)</span></span><br><span class="line">				proxier.filterRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeExternalServicesChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, externalTrafficFilterComment,</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"addrtype"</span>, <span class="string">"--dst-type"</span>, <span class="string">"LOCAL"</span>,</span><br><span class="line">					<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">					<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.NodePort()),</span><br><span class="line">					<span class="string">"-j"</span>, externalTrafficFilterTarget,</span><br><span class="line">				)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture healthCheckNodePorts.</span></span><br><span class="line">		<span class="keyword">if</span> svcInfo.HealthCheckNodePort() != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">// no matter if node has local endpoints, healthCheckNodePorts</span></span><br><span class="line">			<span class="comment">// need to add a rule to accept the incoming connection</span></span><br><span class="line">			proxier.filterRules.Write(</span><br><span class="line">				<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeNodePortsChain),</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"%s health check node port"`</span>, svcPortNameString),</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"tcp"</span>, <span class="string">"-p"</span>, <span class="string">"tcp"</span>,</span><br><span class="line">				<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.HealthCheckNodePort()),</span><br><span class="line">				<span class="string">"-j"</span>, <span class="string">"ACCEPT"</span>,</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If the SVC/SVL/EXT/FW/SEP chains have not changed since the last sync</span></span><br><span class="line">		<span class="comment">// then we can omit them from the restore input. (We have already marked</span></span><br><span class="line">		<span class="comment">// them in activeNATChains, so they won't get deleted.)</span></span><br><span class="line">		<span class="keyword">if</span> tryPartialSync &amp;&amp; !serviceChanged.Has(svcName.NamespacedName.String()) &amp;&amp; !endpointsChanged.Has(svcName.NamespacedName.String()) &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set up internal traffic handling.</span></span><br><span class="line">		<span class="keyword">if</span> hasInternalEndpoints &#123;</span><br><span class="line">			args = <span class="built_in">append</span>(args[:<span class="number">0</span>],</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"%s cluster IP"`</span>, svcPortNameString),</span><br><span class="line">				<span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol,</span><br><span class="line">				<span class="string">"-d"</span>, svcInfo.ClusterIP().String(),</span><br><span class="line">				<span class="string">"--dport"</span>, strconv.Itoa(svcInfo.Port()),</span><br><span class="line">			)</span><br><span class="line">			<span class="keyword">if</span> proxier.masqueradeAll &#123;</span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(internalTrafficChain),</span><br><span class="line">					args,</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(kubeMarkMasqChain))</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> proxier.localDetector.IsImplemented() &#123;</span><br><span class="line">				<span class="comment">// This masquerades off-cluster traffic to a service VIP. The</span></span><br><span class="line">				<span class="comment">// idea is that you can establish a static route for your</span></span><br><span class="line">				<span class="comment">// Service range, routing to any node, and that node will</span></span><br><span class="line">				<span class="comment">// bridge into the Service for you. Since that might bounce</span></span><br><span class="line">				<span class="comment">// off-node, we masquerade here.</span></span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(internalTrafficChain),</span><br><span class="line">					args,</span><br><span class="line">					proxier.localDetector.IfNotLocal(),</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(kubeMarkMasqChain))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set up external traffic handling (if any "external" destinations are</span></span><br><span class="line">		<span class="comment">// enabled). All captured traffic for all external destinations should</span></span><br><span class="line">		<span class="comment">// jump to externalTrafficChain, which will handle some special cases and</span></span><br><span class="line">		<span class="comment">// then jump to externalPolicyChain.</span></span><br><span class="line">		<span class="keyword">if</span> usesExternalTrafficChain &#123;</span><br><span class="line">			proxier.natChains.Write(utiliptables.MakeChainLine(externalTrafficChain))</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> !svcInfo.ExternalPolicyLocal() &#123;</span><br><span class="line">				<span class="comment">// If we are using non-local endpoints we need to masquerade,</span></span><br><span class="line">				<span class="comment">// in case we cross nodes.</span></span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(externalTrafficChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"masquerade traffic for %s external destinations"`</span>, svcPortNameString),</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(kubeMarkMasqChain))</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// If we are only using same-node endpoints, we can retain the</span></span><br><span class="line">				<span class="comment">// source IP in most cases.</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> proxier.localDetector.IsImplemented() &#123;</span><br><span class="line">					<span class="comment">// Treat all locally-originated pod -&gt; external destination</span></span><br><span class="line">					<span class="comment">// traffic as a special-case.  It is subject to neither</span></span><br><span class="line">					<span class="comment">// form of traffic policy, which simulates going up-and-out</span></span><br><span class="line">					<span class="comment">// to an external load-balancer and coming back in.</span></span><br><span class="line">					proxier.natRules.Write(</span><br><span class="line">						<span class="string">"-A"</span>, <span class="keyword">string</span>(externalTrafficChain),</span><br><span class="line">						<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"pod traffic for %s external destinations"`</span>, svcPortNameString),</span><br><span class="line">						proxier.localDetector.IfLocal(),</span><br><span class="line">						<span class="string">"-j"</span>, <span class="keyword">string</span>(clusterPolicyChain))</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Locally originated traffic (not a pod, but the host node)</span></span><br><span class="line">				<span class="comment">// still needs masquerade because the LBIP itself is a local</span></span><br><span class="line">				<span class="comment">// address, so that will be the chosen source IP.</span></span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(externalTrafficChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"masquerade LOCAL traffic for %s external destinations"`</span>, svcPortNameString),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"addrtype"</span>, <span class="string">"--src-type"</span>, <span class="string">"LOCAL"</span>,</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(kubeMarkMasqChain))</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Redirect all src-type=LOCAL -&gt; external destination to the</span></span><br><span class="line">				<span class="comment">// policy=cluster chain. This allows traffic originating</span></span><br><span class="line">				<span class="comment">// from the host to be redirected to the service correctly.</span></span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(externalTrafficChain),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"route LOCAL traffic for %s external destinations"`</span>, svcPortNameString),</span><br><span class="line">					<span class="string">"-m"</span>, <span class="string">"addrtype"</span>, <span class="string">"--src-type"</span>, <span class="string">"LOCAL"</span>,</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(clusterPolicyChain))</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Anything else falls thru to the appropriate policy chain.</span></span><br><span class="line">			<span class="keyword">if</span> hasExternalEndpoints &#123;</span><br><span class="line">				proxier.natRules.Write(</span><br><span class="line">					<span class="string">"-A"</span>, <span class="keyword">string</span>(externalTrafficChain),</span><br><span class="line">					<span class="string">"-j"</span>, <span class="keyword">string</span>(externalPolicyChain))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set up firewall chain, if needed</span></span><br><span class="line">		<span class="keyword">if</span> usesFWChain &#123;</span><br><span class="line">			proxier.natChains.Write(utiliptables.MakeChainLine(fwChain))</span><br><span class="line"></span><br><span class="line">			<span class="comment">// The service firewall rules are created based on the</span></span><br><span class="line">			<span class="comment">// loadBalancerSourceRanges field. This only works for VIP-like</span></span><br><span class="line">			<span class="comment">// loadbalancers that preserve source IPs. For loadbalancers which</span></span><br><span class="line">			<span class="comment">// direct traffic to service NodePort, the firewall rules will not</span></span><br><span class="line">			<span class="comment">// apply.</span></span><br><span class="line">			args = <span class="built_in">append</span>(args[:<span class="number">0</span>],</span><br><span class="line">				<span class="string">"-A"</span>, <span class="keyword">string</span>(fwChain),</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"%s loadbalancer IP"`</span>, svcPortNameString),</span><br><span class="line">			)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// firewall filter based on each source range</span></span><br><span class="line">			allowFromNode := <span class="literal">false</span></span><br><span class="line">			<span class="keyword">for</span> _, src := <span class="keyword">range</span> svcInfo.LoadBalancerSourceRanges() &#123;</span><br><span class="line">				proxier.natRules.Write(args, <span class="string">"-s"</span>, src, <span class="string">"-j"</span>, <span class="keyword">string</span>(externalTrafficChain))</span><br><span class="line">				_, cidr, err := netutils.ParseCIDRSloppy(src)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					klog.ErrorS(err, <span class="string">"Error parsing CIDR in LoadBalancerSourceRanges, dropping it"</span>, <span class="string">"cidr"</span>, cidr)</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> cidr.Contains(proxier.nodeIP) &#123;</span><br><span class="line">					allowFromNode = <span class="literal">true</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// For VIP-like LBs, the VIP is often added as a local</span></span><br><span class="line">			<span class="comment">// address (via an IP route rule).  In that case, a request</span></span><br><span class="line">			<span class="comment">// from a node to the VIP will not hit the loadbalancer but</span></span><br><span class="line">			<span class="comment">// will loop back with the source IP set to the VIP.  We</span></span><br><span class="line">			<span class="comment">// need the following rules to allow requests from this node.</span></span><br><span class="line">			<span class="keyword">if</span> allowFromNode &#123;</span><br><span class="line">				<span class="keyword">for</span> _, lbip := <span class="keyword">range</span> svcInfo.LoadBalancerIPStrings() &#123;</span><br><span class="line">					proxier.natRules.Write(</span><br><span class="line">						args,</span><br><span class="line">						<span class="string">"-s"</span>, lbip,</span><br><span class="line">						<span class="string">"-j"</span>, <span class="keyword">string</span>(externalTrafficChain))</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// If the packet was able to reach the end of firewall chain,</span></span><br><span class="line">			<span class="comment">// then it did not get DNATed, so it will match the</span></span><br><span class="line">			<span class="comment">// corresponding KUBE-PROXY-FIREWALL rule.</span></span><br><span class="line">			proxier.natRules.Write(</span><br><span class="line">				<span class="string">"-A"</span>, <span class="keyword">string</span>(fwChain),</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, fmt.Sprintf(<span class="string">`"other traffic to %s will be dropped by KUBE-PROXY-FIREWALL"`</span>, svcPortNameString),</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If Cluster policy is in use, create the chain and create rules jumping</span></span><br><span class="line">		<span class="comment">// from clusterPolicyChain to the clusterEndpoints</span></span><br><span class="line">		<span class="keyword">if</span> usesClusterPolicyChain &#123;</span><br><span class="line">			proxier.natChains.Write(utiliptables.MakeChainLine(clusterPolicyChain))</span><br><span class="line">			proxier.writeServiceToEndpointRules(svcPortNameString, svcInfo, clusterPolicyChain, clusterEndpoints, args)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If Local policy is in use, create the chain and create rules jumping</span></span><br><span class="line">		<span class="comment">// from localPolicyChain to the localEndpoints</span></span><br><span class="line">		<span class="keyword">if</span> usesLocalPolicyChain &#123;</span><br><span class="line">			proxier.natChains.Write(utiliptables.MakeChainLine(localPolicyChain))</span><br><span class="line">			proxier.writeServiceToEndpointRules(svcPortNameString, svcInfo, localPolicyChain, localEndpoints, args)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Generate the per-endpoint chains.</span></span><br><span class="line">		<span class="keyword">for</span> _, ep := <span class="keyword">range</span> allLocallyReachableEndpoints &#123;</span><br><span class="line">			epInfo, ok := ep.(*endpointsInfo)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				klog.ErrorS(<span class="literal">nil</span>, <span class="string">"Failed to cast endpointsInfo"</span>, <span class="string">"endpointsInfo"</span>, ep)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			endpointChain := epInfo.ChainName</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Create the endpoint chain</span></span><br><span class="line">			proxier.natChains.Write(utiliptables.MakeChainLine(endpointChain))</span><br><span class="line">			activeNATChains[endpointChain] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">			args = <span class="built_in">append</span>(args[:<span class="number">0</span>], <span class="string">"-A"</span>, <span class="keyword">string</span>(endpointChain))</span><br><span class="line">			args = proxier.appendServiceCommentLocked(args, svcPortNameString)</span><br><span class="line">			<span class="comment">// Handle traffic that loops back to the originator with SNAT.</span></span><br><span class="line">			proxier.natRules.Write(</span><br><span class="line">				args,</span><br><span class="line">				<span class="string">"-s"</span>, epInfo.IP(),</span><br><span class="line">				<span class="string">"-j"</span>, <span class="keyword">string</span>(kubeMarkMasqChain))</span><br><span class="line">			<span class="comment">// Update client-affinity lists.</span></span><br><span class="line">			<span class="keyword">if</span> svcInfo.SessionAffinityType() == v1.ServiceAffinityClientIP &#123;</span><br><span class="line">				args = <span class="built_in">append</span>(args, <span class="string">"-m"</span>, <span class="string">"recent"</span>, <span class="string">"--name"</span>, <span class="keyword">string</span>(endpointChain), <span class="string">"--set"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// DNAT to final destination.</span></span><br><span class="line">			args = <span class="built_in">append</span>(args, <span class="string">"-m"</span>, protocol, <span class="string">"-p"</span>, protocol, <span class="string">"-j"</span>, <span class="string">"DNAT"</span>, <span class="string">"--to-destination"</span>, epInfo.Endpoint)</span><br><span class="line">			proxier.natRules.Write(args)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Delete chains no longer in use. Since "iptables-save" can take several seconds</span></span><br><span class="line">	<span class="comment">// to run on hosts with lots of iptables rules, we don't bother to do this on</span></span><br><span class="line">	<span class="comment">// every sync in large clusters. (Stale chains will not be referenced by any</span></span><br><span class="line">	<span class="comment">// active rules, so they're harmless other than taking up memory.)</span></span><br><span class="line">	<span class="keyword">if</span> !proxier.largeClusterMode || time.Since(proxier.lastIPTablesCleanup) &gt; proxier.syncPeriod &#123;</span><br><span class="line">		<span class="keyword">var</span> existingNATChains <span class="keyword">map</span>[utiliptables.Chain]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">		proxier.iptablesData.Reset()</span><br><span class="line">		<span class="keyword">if</span> err := proxier.iptables.SaveInto(utiliptables.TableNAT, proxier.iptablesData); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			existingNATChains = utiliptables.GetChainsFromTable(proxier.iptablesData.Bytes())</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> chain := <span class="keyword">range</span> existingNATChains &#123;</span><br><span class="line">				<span class="keyword">if</span> !activeNATChains[chain] &#123;</span><br><span class="line">					chainString := <span class="keyword">string</span>(chain)</span><br><span class="line">					<span class="keyword">if</span> !isServiceChainName(chainString) &#123;</span><br><span class="line">						<span class="comment">// Ignore chains that aren't ours.</span></span><br><span class="line">						<span class="keyword">continue</span></span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">// We must (as per iptables) write a chain-line</span></span><br><span class="line">					<span class="comment">// for it, which has the nice effect of flushing</span></span><br><span class="line">					<span class="comment">// the chain. Then we can remove the chain.</span></span><br><span class="line">					proxier.natChains.Write(utiliptables.MakeChainLine(chain))</span><br><span class="line">					proxier.natRules.Write(<span class="string">"-X"</span>, chainString)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			proxier.lastIPTablesCleanup = time.Now()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			klog.ErrorS(err, <span class="string">"Failed to execute iptables-save: stale chains will not be deleted"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Finally, tail-call to the nodePorts chain.  This needs to be after all</span></span><br><span class="line">	<span class="comment">// other service portal rules.</span></span><br><span class="line">	nodeAddresses, err := proxier.nodePortAddresses.GetNodeAddresses(proxier.networkInterfacer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.ErrorS(err, <span class="string">"Failed to get node ip address matching nodeport cidrs, services with nodeport may not work as intended"</span>, <span class="string">"CIDRs"</span>, proxier.nodePortAddresses)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// nodeAddresses may contain dual-stack zero-CIDRs if proxier.nodePortAddresses is empty.</span></span><br><span class="line">	<span class="comment">// Ensure nodeAddresses only contains the addresses for this proxier's IP family.</span></span><br><span class="line">	<span class="keyword">for</span> addr := <span class="keyword">range</span> nodeAddresses &#123;</span><br><span class="line">		<span class="keyword">if</span> utilproxy.IsZeroCIDR(addr) &amp;&amp; isIPv6 == netutils.IsIPv6CIDRString(addr) &#123;</span><br><span class="line">			<span class="comment">// if any of the addresses is zero cidr of this IP family, non-zero IPs can be excluded.</span></span><br><span class="line">			nodeAddresses = sets.New[<span class="keyword">string</span>](addr)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> address := <span class="keyword">range</span> nodeAddresses &#123;</span><br><span class="line">		<span class="keyword">if</span> utilproxy.IsZeroCIDR(address) &#123;</span><br><span class="line">			destinations := []<span class="keyword">string</span>&#123;<span class="string">"-m"</span>, <span class="string">"addrtype"</span>, <span class="string">"--dst-type"</span>, <span class="string">"LOCAL"</span>&#125;</span><br><span class="line">			<span class="keyword">if</span> isIPv6 &#123;</span><br><span class="line">				<span class="comment">// For IPv6, Regardless of the value of localhostNodePorts is true</span></span><br><span class="line">				<span class="comment">// or false, we should disable access to the nodePort via localhost. Since it never works and always</span></span><br><span class="line">				<span class="comment">// cause kernel warnings.</span></span><br><span class="line">				destinations = <span class="built_in">append</span>(destinations, <span class="string">"!"</span>, <span class="string">"-d"</span>, <span class="string">"::1/128"</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> !proxier.localhostNodePorts &amp;&amp; !isIPv6 &#123;</span><br><span class="line">				<span class="comment">// If set localhostNodePorts to "false"(route_localnet=0), We should generate iptables rules that</span></span><br><span class="line">				<span class="comment">// disable NodePort services to be accessed via localhost. Since it doesn't work and causes</span></span><br><span class="line">				<span class="comment">// the kernel to log warnings if anyone tries.</span></span><br><span class="line">				destinations = <span class="built_in">append</span>(destinations, <span class="string">"!"</span>, <span class="string">"-d"</span>, <span class="string">"127.0.0.0/8"</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			proxier.natRules.Write(</span><br><span class="line">				<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeServicesChain),</span><br><span class="line">				<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, <span class="string">`"kubernetes service nodeports; NOTE: this must be the last rule in this chain"`</span>,</span><br><span class="line">				destinations,</span><br><span class="line">				<span class="string">"-j"</span>, <span class="keyword">string</span>(kubeNodePortsChain))</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Ignore IP addresses with incorrect version</span></span><br><span class="line">		<span class="keyword">if</span> isIPv6 &amp;&amp; !netutils.IsIPv6String(address) || !isIPv6 &amp;&amp; netutils.IsIPv6String(address) &#123;</span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">"IP has incorrect IP version"</span>, <span class="string">"IP"</span>, address)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// For ipv6, Regardless of the value of localhostNodePorts is true or false, we should disallow access</span></span><br><span class="line">		<span class="comment">// to the nodePort via lookBack address.</span></span><br><span class="line">		<span class="keyword">if</span> isIPv6 &amp;&amp; utilproxy.IsLoopBack(address) &#123;</span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">"disallow nodePort services to be accessed via ipv6 localhost address"</span>, <span class="string">"IP"</span>, address)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// For ipv4, When localhostNodePorts is set to false, Ignore ipv4 lookBack address</span></span><br><span class="line">		<span class="keyword">if</span> !isIPv6 &amp;&amp; utilproxy.IsLoopBack(address) &amp;&amp; !proxier.localhostNodePorts &#123;</span><br><span class="line">			klog.ErrorS(<span class="literal">nil</span>, <span class="string">"disallow nodePort services to be accessed via ipv4 localhost address"</span>, <span class="string">"IP"</span>, address)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// create nodeport rules for each IP one by one</span></span><br><span class="line">		proxier.natRules.Write(</span><br><span class="line">			<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeServicesChain),</span><br><span class="line">			<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, <span class="string">`"kubernetes service nodeports; NOTE: this must be the last rule in this chain"`</span>,</span><br><span class="line">			<span class="string">"-d"</span>, address,</span><br><span class="line">			<span class="string">"-j"</span>, <span class="keyword">string</span>(kubeNodePortsChain))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Drop the packets in INVALID state, which would potentially cause</span></span><br><span class="line">	<span class="comment">// unexpected connection reset.</span></span><br><span class="line">	<span class="comment">// https://github.com/kubernetes/kubernetes/issues/74839</span></span><br><span class="line">	proxier.filterRules.Write(</span><br><span class="line">		<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeForwardChain),</span><br><span class="line">		<span class="string">"-m"</span>, <span class="string">"conntrack"</span>,</span><br><span class="line">		<span class="string">"--ctstate"</span>, <span class="string">"INVALID"</span>,</span><br><span class="line">		<span class="string">"-j"</span>, <span class="string">"DROP"</span>,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If the masqueradeMark has been added then we want to forward that same</span></span><br><span class="line">	<span class="comment">// traffic, this allows NodePort traffic to be forwarded even if the default</span></span><br><span class="line">	<span class="comment">// FORWARD policy is not accept.</span></span><br><span class="line">	proxier.filterRules.Write(</span><br><span class="line">		<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeForwardChain),</span><br><span class="line">		<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, <span class="string">`"kubernetes forwarding rules"`</span>,</span><br><span class="line">		<span class="string">"-m"</span>, <span class="string">"mark"</span>, <span class="string">"--mark"</span>, fmt.Sprintf(<span class="string">"%s/%s"</span>, proxier.masqueradeMark, proxier.masqueradeMark),</span><br><span class="line">		<span class="string">"-j"</span>, <span class="string">"ACCEPT"</span>,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The following rule ensures the traffic after the initial packet accepted</span></span><br><span class="line">	<span class="comment">// by the "kubernetes forwarding rules" rule above will be accepted.</span></span><br><span class="line">	proxier.filterRules.Write(</span><br><span class="line">		<span class="string">"-A"</span>, <span class="keyword">string</span>(kubeForwardChain),</span><br><span class="line">		<span class="string">"-m"</span>, <span class="string">"comment"</span>, <span class="string">"--comment"</span>, <span class="string">`"kubernetes forwarding conntrack rule"`</span>,</span><br><span class="line">		<span class="string">"-m"</span>, <span class="string">"conntrack"</span>,</span><br><span class="line">		<span class="string">"--ctstate"</span>, <span class="string">"RELATED,ESTABLISHED"</span>,</span><br><span class="line">		<span class="string">"-j"</span>, <span class="string">"ACCEPT"</span>,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	metrics.IptablesRulesTotal.WithLabelValues(<span class="keyword">string</span>(utiliptables.TableFilter)).Set(<span class="keyword">float64</span>(proxier.filterRules.Lines()))</span><br><span class="line">	metrics.IptablesRulesTotal.WithLabelValues(<span class="keyword">string</span>(utiliptables.TableNAT)).Set(<span class="keyword">float64</span>(proxier.natRules.Lines()))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sync rules.</span></span><br><span class="line">	proxier.iptablesData.Reset()</span><br><span class="line">	proxier.iptablesData.WriteString(<span class="string">"*filter\n"</span>)</span><br><span class="line">	proxier.iptablesData.Write(proxier.filterChains.Bytes())</span><br><span class="line">	proxier.iptablesData.Write(proxier.filterRules.Bytes())</span><br><span class="line">	proxier.iptablesData.WriteString(<span class="string">"COMMIT\n"</span>)</span><br><span class="line">	proxier.iptablesData.WriteString(<span class="string">"*nat\n"</span>)</span><br><span class="line">	proxier.iptablesData.Write(proxier.natChains.Bytes())</span><br><span class="line">	proxier.iptablesData.Write(proxier.natRules.Bytes())</span><br><span class="line">	proxier.iptablesData.WriteString(<span class="string">"COMMIT\n"</span>)</span><br><span class="line"></span><br><span class="line">	klog.V(<span class="number">2</span>).InfoS(<span class="string">"Reloading service iptables data"</span>,</span><br><span class="line">		<span class="string">"numServices"</span>, <span class="built_in">len</span>(proxier.svcPortMap),</span><br><span class="line">		<span class="string">"numEndpoints"</span>, totalEndpoints,</span><br><span class="line">		<span class="string">"numFilterChains"</span>, proxier.filterChains.Lines(),</span><br><span class="line">		<span class="string">"numFilterRules"</span>, proxier.filterRules.Lines(),</span><br><span class="line">		<span class="string">"numNATChains"</span>, proxier.natChains.Lines(),</span><br><span class="line">		<span class="string">"numNATRules"</span>, proxier.natRules.Lines(),</span><br><span class="line">	)</span><br><span class="line">	klog.V(<span class="number">9</span>).InfoS(<span class="string">"Restoring iptables"</span>, <span class="string">"rules"</span>, proxier.iptablesData.Bytes())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> NoFlushTables is used so we don't flush non-kubernetes chains in the table</span></span><br><span class="line">	err = proxier.iptables.RestoreAll(proxier.iptablesData.Bytes(), utiliptables.NoFlushTables, utiliptables.RestoreCounters)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> pErr, ok := err.(utiliptables.ParseError); ok &#123;</span><br><span class="line">			lines := utiliptables.ExtractLines(proxier.iptablesData.Bytes(), pErr.Line(), <span class="number">3</span>)</span><br><span class="line">			klog.ErrorS(pErr, <span class="string">"Failed to execute iptables-restore"</span>, <span class="string">"rules"</span>, lines)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			klog.ErrorS(err, <span class="string">"Failed to execute iptables-restore"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		metrics.IptablesRestoreFailuresTotal.Inc()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	success = <span class="literal">true</span></span><br><span class="line">	proxier.needFullSync = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> name, lastChangeTriggerTimes := <span class="keyword">range</span> endpointUpdateResult.LastChangeTriggerTimes &#123;</span><br><span class="line">		<span class="keyword">for</span> _, lastChangeTriggerTime := <span class="keyword">range</span> lastChangeTriggerTimes &#123;</span><br><span class="line">			latency := metrics.SinceInSeconds(lastChangeTriggerTime)</span><br><span class="line">			metrics.NetworkProgrammingLatency.Observe(latency)</span><br><span class="line">			klog.V(<span class="number">4</span>).InfoS(<span class="string">"Network programming"</span>, <span class="string">"endpoint"</span>, klog.KRef(name.Namespace, name.Name), <span class="string">"elapsed"</span>, latency)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	metrics.SyncProxyRulesNoLocalEndpointsTotal.WithLabelValues(<span class="string">"internal"</span>).Set(<span class="keyword">float64</span>(serviceNoLocalEndpointsTotalInternal))</span><br><span class="line">	metrics.SyncProxyRulesNoLocalEndpointsTotal.WithLabelValues(<span class="string">"external"</span>).Set(<span class="keyword">float64</span>(serviceNoLocalEndpointsTotalExternal))</span><br><span class="line">	<span class="keyword">if</span> proxier.healthzServer != <span class="literal">nil</span> &#123;</span><br><span class="line">		proxier.healthzServer.Updated()</span><br><span class="line">	&#125;</span><br><span class="line">	metrics.SyncProxyRulesLastTimestamp.SetToCurrentTime()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Update service healthchecks.  The endpoints list might include services that are</span></span><br><span class="line">	<span class="comment">// not "OnlyLocal", but the services list will not, and the serviceHealthServer</span></span><br><span class="line">	<span class="comment">// will just drop those endpoints.</span></span><br><span class="line">	<span class="keyword">if</span> err := proxier.serviceHealthServer.SyncServices(proxier.svcPortMap.HealthCheckNodePorts()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.ErrorS(err, <span class="string">"Error syncing healthcheck services"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := proxier.serviceHealthServer.SyncEndpoints(proxier.endpointsMap.LocalReadyEndpoints()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.ErrorS(err, <span class="string">"Error syncing healthcheck endpoints"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Finish housekeeping, clear stale conntrack entries for UDP Services</span></span><br><span class="line">	conntrack.CleanStaleEntries(proxier.iptables.IsIPv6(), proxier.exec, proxier.svcPortMap, serviceUpdateResult, endpointUpdateResult)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<p>REF:<br>1.<a href="https://github.com/kubernetes/kubernetes/blob/release-1.27/cmd/kube-proxy/proxy.go" target="_blank" rel="noopener">cmd/kube-proxy/proxy.go</a><br>2.<a href="https://github.com/kubernetes/kubernetes/blob/release-1.27/cmd/kube-proxy/app/server.go" target="_blank" rel="noopener">cmd/kube-proxy/app/server.go</a><br>3.<a href="https://github.com/kubernetes/kubernetes/blob/release-1.27/cmd/kube-proxy/app/server_others.go" target="_blank" rel="noopener">cmd/kube-proxy/app/server_others.go</a><br>4.<a href="https://github.com/kubernetes/kubernetes/blob/release-1.27/pkg/proxy/config/config.go" target="_blank" rel="noopener">pkg/proxy/config/config.go</a><br>5.<a href="https://github.com/kubernetes/kubernetes/blob/release-1.27/pkg/proxy/ipvs/proxier.go" target="_blank" rel="noopener">pkg/proxy/ipvs/proxier.go</a><br>6.<a href="https://github.com/kubernetes/kubernetes/blob/release-1.27/pkg/proxy/iptables/proxier.go" target="_blank" rel="noopener">pkg/proxy/iptables/proxier.go</a></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag">k8s</i></a>
          
            <a href="/tags/kube-proxy/" rel="tag"><i class="fa fa-tag">kube-proxy</i></a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2023/05/23/k8s之rbac/" rel="prev" title="k8s之rbac">
                <i class="fa fa-chevron-left"></i> k8s之rbac
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/05/20/k8s之kube-proxy/" rel="prev" title="k8s之kube-proxy[上]">
                k8s之kube-proxy[上] <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>
  <div>
  
<div>
<script src="https://giscus.app/client.js" data-repo="hysyeah/comment" data-repo-id="R_kgDOJXD3Cw" data-category="General" data-category-id="DIC_kwDOJXD3C84CVy5V" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async>
</script>
</div>

  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">hys</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">329</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">hysyeah.top &copy; <span itemprop="copyrightYear">2019-2025</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"><a href="http://www.beian.miit.gov.cn" class="theme-link" rel="noopener" target="_blank">粤ICP备19077752号</a></span>

  

  
</div>


<!--
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.2</div>
-->





        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>



  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').not('.gist .highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      const selection = document.getSelection();
      const selected = selection.rangeCount > 0 ? selection.getRangeAt(0) : false;
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
      if (selected) {
        selection.removeAllRanges();
        selection.addRange(selected);
      }
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  


  
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
  <script type="text/javascript" src="/js/clipboard.min.js"></script>
  <script type="text/javascript" src="/js/clipboard-use.js"></script>


</body>
</html>
